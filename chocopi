#!/usr/bin/env bash

export PYTHONUTF8=1                       # Force UTF-8 encoding
export CHOCO_DISPLAY=${CHOCO_DISPLAY:-1}  # Enable display, default to 1 if unset
export CHOCO_LOG=${CHOCO_LOG:-INFO}       # Set log level, default to INFO if unset

# Configure audio on Linux systems
if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    # Set XDG_RUNTIME_DIR for PipeWire audio
    export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$(id -u)}

    # Prefer DSI display device for KMSDRM when available
    if [[ -z ${SDL_KMSDRM_DEVICE_INDEX+x} ]]; then
        # Find connected DSI display
        for status in /sys/class/drm/card*-DSI-*/status; do
            if [[ -f "$status" ]] && [[ "$(cat "$status")" == "connected" ]]; then
                CARD_INDEX=$(echo "$status" | grep -oP 'card\K[0-9]+')
                export SDL_KMSDRM_DEVICE_INDEX="$CARD_INDEX"
                break
            fi
        done
    fi

    # Wait for WirePlumber and default devices to be ready
    if command -v wpctl > /dev/null 2>&1; then
        AUDIO_READY=false
        for i in {1..25}; do  # 5 seconds max
            if wpctl inspect @DEFAULT_SINK@ &>/dev/null && wpctl inspect @DEFAULT_SOURCE@ &>/dev/null; then
                AUDIO_READY=true
                break
            fi
            sleep 0.2
        done

        if [ "$AUDIO_READY" = "true" ]; then
            DEFAULT_INPUT_VOLUME=100%
            DEFAULT_OUTPUT_VOLUME=100%

            echo "üéõÔ∏è  Setting audio volume..."
            wpctl set-volume @DEFAULT_SINK@ $DEFAULT_OUTPUT_VOLUME && \
            echo "‚úÖ Set output volume: $DEFAULT_OUTPUT_VOLUME" || \
            echo "‚ö†Ô∏è  Failed to set output volume"

            wpctl set-volume @DEFAULT_SOURCE@ $DEFAULT_INPUT_VOLUME && \
            echo "‚úÖ Set input volume: $DEFAULT_INPUT_VOLUME" || \
            echo "‚ö†Ô∏è  Failed to set input volume"
        else
            echo "‚ö†Ô∏è  Audio system not ready, skipping volume setup"
        fi
    fi
fi

SCRIPTPATH=$(dirname $0)
source $SCRIPTPATH/.venv/bin/activate
cd $SCRIPTPATH
python -m chocopi
